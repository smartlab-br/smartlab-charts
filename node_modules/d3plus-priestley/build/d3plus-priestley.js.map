{"version":3,"file":"d3plus-priestley.js","sources":["../src/Priestley.js"],"sourcesContent":["/**\n    @external Viz\n    @see https://github.com/d3plus/d3plus-viz#Viz\n*/\n\nimport {min, max, range} from \"d3-array\";\nimport {nest} from \"d3-collection\";\nimport {scalePoint} from \"d3-scale\";\n\nimport {Axis, date} from \"d3plus-axis\";\nimport {accessor, assign, configPrep, elem} from \"d3plus-common\";\nimport {Rect} from \"d3plus-shape\";\nimport {Viz} from \"d3plus-viz\";\n\n/**\n    @class Priestley\n    @extends external:Viz\n    @desc Creates a priestley timeline based on an array of data.\n*/\nexport default class Priestley extends Viz {\n\n  /**\n      @memberof Priestley\n      @desc Invoked when creating a new class instance, and sets any default parameters.\n      @private\n  */\n  constructor() {\n\n    super();\n\n    this._axis = new Axis().align(\"end\").orient(\"bottom\");\n    this._axisConfig = {scale: \"time\"};\n    this._axisTest = new Axis().align(\"end\").gridSize(0).orient(\"bottom\");\n    this.end(\"end\");\n    this._shapeConfig = assign({}, this._shapeConfig, {\n      ariaLabel: (d, i) => `${this._drawLabel(d, i)}, ${this._start(d, i)} - ${this._end(d, i)}.`\n    });\n    this.start(\"start\");\n\n  }\n\n  /**\n      @memberof Priestley\n      @desc Extends the render behavior of the abstract Viz class.\n      @private\n  */\n  render(callback) {\n\n    super.render(callback);\n\n    if (!this._filteredData) return this;\n\n    const data = this._filteredData.map((data, i) => ({\n      __d3plus__: true,\n      data,\n      end: this._axisConfig.scale === \"time\" ? date(this._end(data, i)) : this._end(data, i),\n      i,\n      id: this._id(data, i),\n      start: this._axisConfig.scale === \"time\" ? date(this._start(data, i)) : this._start(data, i)\n    })).filter(d => d.end - d.start > 0).sort((a, b) => a.start - b.start);\n\n    let nestedData;\n    if (this._groupBy.length > 1 && this._drawDepth > 0) {\n      const dataNest = nest();\n      for (let i = 0; i < this._drawDepth; i++) dataNest.key(d => this._groupBy[i](d.data, d.i));\n      nestedData = dataNest.entries(data);\n    }\n    else nestedData = [{values: data}];\n\n    let maxLane = 0;\n    nestedData.forEach(g => {\n      let track = [];\n      g.values.forEach(d => {\n        track = track.map(t => t <= d.start ? false : t);\n        const i = track.indexOf(false);\n        if (i < 0) {\n          d.lane = maxLane + track.length;\n          track.push(d.end);\n        }\n        else {\n          track[i] = d.end;\n          d.lane = maxLane + i;\n        }\n      });\n      maxLane += track.length;\n    });\n\n    const axisConfig = {\n      domain: [min(data, d => d.start) || 0, max(data, d => d.end) || 0],\n      height: this._height - this._margin.top - this._margin.bottom,\n      width: this._width - this._margin.left - this._margin.right\n    };\n\n    const transform = `translate(${this._margin.left}, ${this._margin.top})`;\n\n    this._axisTest\n      .config(axisConfig)\n      .config(this._axisConfig)\n      .select(elem(\"g.d3plus-priestley-axis-test\", {parent: this._select, enter: {opacity: 0}}).node())\n      .render();\n\n    this._axis\n      .config(axisConfig)\n      .config(this._axisConfig)\n      .select(elem(\"g.d3plus-priestley-axis\", {parent: this._select, enter: {transform}, update: {transform}}).node())\n      .render();\n\n    const axisPad = this._axisTest._padding;\n\n    const xScale = this._axis._d3Scale;\n\n    const yScale = scalePoint()\n      .domain(range(0, maxLane, 1))\n      .padding(0.5)\n      .rangeRound([this._height - this._margin.bottom - this._axisTest.outerBounds().height - axisPad, this._margin.top + axisPad]);\n\n    const step = yScale.step();\n\n    this._shapes.push(new Rect()\n      .data(data)\n      .duration(this._duration)\n      .height(step >= this._padding * 2 ? step - this._padding : step > 2 ? step - 2 : step)\n      .label((d, i) => this._drawLabel(d.data, i))\n      .select(elem(\"g.d3plus-priestley-shapes\", {parent: this._select}).node())\n      .width(d => {\n        const w = Math.abs(xScale(d.end) - xScale(d.start));\n        return w > 2 ? w - 2 : w;\n      })\n      .x(d => xScale(d.start) + (xScale(d.end) - xScale(d.start)) / 2)\n      .y(d => yScale(d.lane))\n      .config(configPrep.bind(this)(this._shapeConfig, \"shape\", \"Rect\"))\n      .render());\n\n    return this;\n\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the config method for the axis and returns the current class instance. If *value* is not specified, returns the current axis configuration.\n      @param {Object} [*value*]\n      @chainable\n  */\n  axisConfig(_) {\n    return arguments.length ? (this._axisConfig = assign(this._axisConfig, _), this) : this._axisConfig;\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the end accessor to the specified function or key and returns the current class instance. If *value* is not specified, returns the current end accessor.\n      @param {Function|String} [*value*]\n      @chainable\n  */\n  end(_) {\n    if (arguments.length) {\n      if (typeof _ === \"function\") this._end = _;\n      else {\n        this._end = accessor(_);\n        if (!this._aggs[_]) this._aggs[_] = a => max(a);\n      }\n      return this;\n    }\n    else return this._end;\n  }\n\n  /**\n      @memberof Priestley\n      @desc If *value* is specified, sets the start accessor to the specified function or key and returns the current class instance. If *value* is not specified, returns the current start accessor.\n      @param {Function|String} [*value*]\n      @chainable\n  */\n  start(_) {\n    if (arguments.length) {\n      if (typeof _ === \"function\") this._start = _;\n      else {\n        this._start = accessor(_);\n        if (!this._aggs[_]) this._aggs[_] = a => min(a);\n      }\n      return this;\n    }\n    else return this._start;\n  }\n\n}\n"],"names":["super","Axis","assign","this","const","date","let","nest","i","min","max","elem","scalePoint","range","Rect","configPrep","accessor","Viz"],"mappings":"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"}